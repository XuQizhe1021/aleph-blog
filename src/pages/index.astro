---
import Layout from '../layouts/Layout.astro';
import PostCard from '../components/PostCard.astro';
import { getPublicPosts, getAllCategories } from '../utils/blog';
import { withBase } from '../utils/paths';

const posts = await getPublicPosts();
const allCategories = getAllCategories(posts);
const categories = allCategories.slice(0, 8);
const latest = posts.slice(0, 8);

const totalPosts = posts.length;
const totalCategories = allCategories.length;
const latestUpdateTs = posts.reduce((max, post) => {
	const t = (post.data.updatedDate ?? post.data.pubDate).getTime();
	return Math.max(max, t);
}, 0);
const latestUpdateText = latestUpdateTs
	? new Date(latestUpdateTs).toLocaleDateString('zh-CN')
	: '—';
---

<Layout title="首页">
	<section class="hero panel">
		<div class="hero-head">
			<div class="hero-title">站点概览</div>
			<div class="hero-actions">
				<a class="btn" href={withBase('/posts')}>浏览文章</a>
				<a class="btn" href={withBase('/search')}>搜索</a>
			</div>
		</div>
		<div class="stats">
			<div class="stat">
				<div class="stat-k muted">文章</div>
				<div class="stat-v">{totalPosts}</div>
			</div>
			<div class="stat">
				<div class="stat-k muted">分类</div>
				<div class="stat-v">{totalCategories}</div>
			</div>
			<div class="stat">
				<div class="stat-k muted">最近更新</div>
				<div class="stat-v">{latestUpdateText}</div>
			</div>
			<div class="stat">
				<div class="stat-k muted">访问次数</div>
				<div class="stat-v" data-site-views>—</div>
			</div>
		</div>
	</section>

	<section class="section">
		<div class="section-head">
			<h2>最新文章</h2>
			<a class="muted" href={withBase('/posts')}>查看全部 →</a>
		</div>
		<div class="grid">
			{latest.length ? latest.map((post) => <PostCard post={post} />) : <div class="muted">暂无文章</div>}
		</div>
	</section>

	<section class="section">
		<div class="section-head">
			<h2>热门分类</h2>
			<a class="muted" href={withBase('/categories')}>查看全部 →</a>
		</div>
		<div class="cats">
			{categories.length ? (
				categories.map((c) => (
					<a class="cat panel" href={withBase(`/categories/${encodeURIComponent(c.category)}`)}>
						<div class="cat-name">{c.category}</div>
						<div class="cat-count muted">{c.count} 篇</div>
					</a>
				))
			) : (
				<div class="muted">暂无分类</div>
			)}
		</div>
	</section>
</Layout>

<style>
	.hero {
		padding: 22px 18px;
		display: grid;
		gap: 12px;
	}

	.hero-head {
		display: flex;
		align-items: center;
		justify-content: space-between;
		gap: 12px;
	}

	.hero-title {
		font-size: clamp(18px, 4.2vw, 28px);
		font-weight: 800;
		letter-spacing: 0.2px;
	}

	.hero-actions {
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
		justify-content: flex-end;
	}

	.stats {
		display: grid;
		grid-template-columns: repeat(4, minmax(0, 1fr));
		gap: 12px;
	}

	.stat {
		padding: 12px 14px;
		border-radius: 14px;
		border: 1px solid var(--border);
		background: color-mix(in oklab, rgba(255, 255, 255, 0.06), transparent 15%);
		display: grid;
		gap: 4px;
	}

	.stat-k {
		font-size: 12px;
	}

	.stat-v {
		font-size: 18px;
		font-weight: 800;
		letter-spacing: 0.2px;
	}

	.section {
		margin-top: 18px;
	}

	.section-head {
		display: flex;
		align-items: baseline;
		justify-content: space-between;
		gap: 10px;
		margin: 10px 2px;
	}

	h2 {
		margin: 0;
	}

	.grid {
		display: grid;
		grid-template-columns: repeat(2, minmax(0, 1fr));
		gap: 12px;
	}

	.cats {
		display: grid;
		grid-template-columns: repeat(4, minmax(0, 1fr));
		gap: 12px;
	}

	.cat {
		padding: 14px 14px 12px;
		text-decoration: none;
		display: grid;
		gap: 6px;
	}

	.cat:hover {
		border-color: color-mix(in oklab, var(--accent), var(--border) 30%);
		text-decoration: none;
	}

	.cat-name {
		font-weight: 700;
	}

	.cat-count {
		font-size: 13px;
	}

	@media (max-width: 980px) {
		.grid {
			grid-template-columns: 1fr;
		}
		.cats {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
		.stats {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
	}
</style>
