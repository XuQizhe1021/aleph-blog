---
import Layout from '../../layouts/Layout.astro';
import Toc from '../../components/Toc.astro';
import { getCollection } from 'astro:content';
import { getCategories, getPrimaryCategory } from '../../utils/blog';
import { withBase } from '../../utils/paths';

export async function getStaticPaths() {
	const posts = await getCollection('blog', ({ data }) => !data.draft);
	return posts.map((post) => ({
		params: { slug: post.slug },
		props: { post },
	}));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const categories = getCategories(post);
const primaryCategory = getPrimaryCategory(post);
---

<Layout title={post.data.title} description={post.data.description}>
	<article class="article">
		<header class="article-head panel">
			<h1 class="article-title">{post.data.title}</h1>
			<div class="article-meta muted">
				<time datetime={post.data.pubDate.toISOString()}>
					发布于 {post.data.pubDate.toLocaleDateString('zh-CN')}
				</time>
				{post.data.updatedDate ? (
					<span>
						<span class="dot" aria-hidden="true">·</span>
						<time datetime={post.data.updatedDate.toISOString()}>
							更新于 {post.data.updatedDate.toLocaleDateString('zh-CN')}
						</time>
					</span>
				) : null}
				<span>
					<span class="dot" aria-hidden="true">·</span>
					<a class="meta-link" href={withBase(`/categories/${encodeURIComponent(primaryCategory)}`)}>{primaryCategory}</a>
				</span>
			</div>
			{categories.length ? (
				<div class="article-tags">
					{categories.map((c) => (
						<a class="badge" href={withBase(`/categories/${encodeURIComponent(c)}`)}>{c}</a>
					))}
				</div>
			) : null}
		</header>

		<div class="toc-mobile">
			<Toc headings={headings} variant="floating" />
		</div>

		<div class="article-body">
			<div class="content panel">
				<div class="prose">
					<Content />
				</div>
			</div>
			<div class="side">
				<Toc headings={headings} variant="sidebar" />
			</div>
		</div>
	</article>
</Layout>

<style>
	.article {
		display: grid;
		gap: 14px;
	}

	.article-head {
		padding: 18px;
	}

	.article-title {
		margin: 0 0 10px;
		font-size: clamp(22px, 4vw, 34px);
		letter-spacing: 0.2px;
	}

	.article-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 10px;
		font-size: 13px;
	}

	.dot {
		margin: 0 8px;
		opacity: 0.6;
	}

	.meta-link {
		color: inherit;
		text-decoration: none;
	}

	.meta-link:hover {
		text-decoration: underline;
	}

	.article-tags {
		margin-top: 12px;
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}

	.article-body {
		display: grid;
		grid-template-columns: minmax(0, 1fr) 280px;
		gap: 14px;
		align-items: start;
	}

	.content {
		padding: 18px;
	}

	.toc-mobile {
		display: none;
	}

	.side {
		display: grid;
		gap: 14px;
		align-self: stretch;
	}

	@media (max-width: 980px) {
		.toc-mobile {
			display: block;
		}
		.article-body {
			grid-template-columns: 1fr;
		}
		.side {
			display: none;
		}
	}

</style>
