---
import Layout from '../layouts/Layout.astro';
---

<Layout title="搜索">
	<section class="panel search">
		<div class="search-title">搜索</div>
		<div class="row">
			<input id="q" class="input" placeholder="输入标题 / 内容关键词…" />
			<button id="clear" class="btn" type="button">清空</button>
		</div>
		<div class="muted hint">支持标题、正文、分类联合匹配。</div>
	</section>

	<section id="results" class="results search-results"></section>

	<script>
		import Fuse from 'fuse.js';

		type SearchItem = {
			slug: string;
			title: string;
			description: string;
			categories: string[];
			pubDate: string;
			text: string;
		};

		const $q = document.getElementById('q') as HTMLInputElement | null;
		const $clear = document.getElementById('clear') as HTMLButtonElement | null;
		const $results = document.getElementById('results') as HTMLElement | null;

		const base = import.meta.env.BASE_URL.endsWith('/') ? import.meta.env.BASE_URL : `${import.meta.env.BASE_URL}/`;
		const resp = await fetch(`${base}search.json`);
		const data = (await resp.json()) as { items?: SearchItem[] };
		const items = data.items ?? [];

		const fuse = new Fuse<SearchItem>(items, {
			includeScore: true,
			threshold: 0.35,
			ignoreLocation: true,
			keys: [
				{ name: 'title', weight: 0.45 },
				{ name: 'description', weight: 0.1 },
				{ name: 'categories', weight: 0.2 },
				{ name: 'text', weight: 0.25 },
			],
		});

		const escapeHtml = (s: string) =>
			String(s).replace(/[&<>"']/g, (ch) => {
				if (ch === '&') return '&amp;';
				if (ch === '<') return '&lt;';
				if (ch === '>') return '&gt;';
				if (ch === '"') return '&quot;';
				return '&#39;';
			});

		const render = (rows: Array<{ item: SearchItem } | SearchItem>, query: string) => {
			if (!$results) return;
			if (!query) {
				$results.innerHTML = `
					<div class="panel empty">
						<div class="empty-title">开始搜索</div>
						<div class="muted empty-sub">输入标题、正文关键词或分类名称。</div>
					</div>
				`;
				return;
			}
			if (!rows.length) {
				$results.innerHTML = `
					<div class="panel empty">
						<div class="empty-title">未找到结果</div>
						<div class="muted empty-sub">换个关键词试试，或减少关键词数量。</div>
					</div>
				`;
				return;
			}
			$results.innerHTML = rows
				.map((r) => {
					const item = 'item' in r ? r.item : r;
					const url = `${base}posts/${item.slug}/`;
					const dateText = item.pubDate ? new Date(item.pubDate).toLocaleDateString('zh-CN') : '';
					const categories = (item.categories?.length ? item.categories : ['未分类']).map((c) =>
						String(c).trim()
					);
					const primary = categories[0] ?? '未分类';
					const primaryHref = `${base}categories/${encodeURIComponent(primary)}/`;
					const tags = categories
						.slice(0, 12)
						.map((c) => {
							const href = `${base}categories/${encodeURIComponent(c)}/`;
							return `<a class="badge" href="${href}">${escapeHtml(c)}</a>`;
						})
						.join('');
					return `
						<article class="post-card panel">
							<div class="meta">
								<a class="post-title" href="${url}">${escapeHtml(item.title)}</a>
								<div class="post-sub muted">
									${dateText ? `<time datetime="${escapeHtml(item.pubDate)}">${dateText}</time>` : ''}
									<span class="dot" aria-hidden="true">·</span>
									<a class="cat" href="${primaryHref}">${escapeHtml(primary)}</a>
								</div>
							</div>
							${item.description ? `<p class="desc muted">${escapeHtml(item.description)}</p>` : ''}
							${tags ? `<div class="tags">${tags}</div>` : ''}
						</article>
					`;
				})
				.join('');
		};

		const doSearch = () => {
			const query = ($q?.value ?? '').trim();
			if (!query) return render([], '');
			const res = fuse.search(query).slice(0, 30);
			render(res, query);
		};

		$q?.addEventListener('input', () => doSearch());
		$clear?.addEventListener('click', () => {
			if ($q) $q.value = '';
			doSearch();
			$q?.focus();
		});

		const url = new URL(window.location.href);
		const initial = url.searchParams.get('q');
		if (initial && $q) {
			$q.value = initial;
		}
		doSearch();
	</script>
</Layout>

<style>
	.search {
		padding: 18px;
		display: grid;
		gap: 10px;
	}

	.search-title {
		font-size: 24px;
		font-weight: 850;
	}

	.row {
		display: grid;
		grid-template-columns: 1fr auto;
		gap: 10px;
		align-items: center;
	}

	.input {
		height: 40px;
		padding: 0 14px;
		border-radius: 999px;
		border: 1px solid var(--border);
		background: color-mix(in oklab, var(--panel-strong), transparent 10%);
		color: var(--text);
		outline: none;
	}

	.input:focus {
		border-color: color-mix(in oklab, var(--accent), var(--border) 20%);
		box-shadow: 0 0 0 4px color-mix(in oklab, var(--accent), transparent 86%);
	}

	.hint {
		font-size: 13px;
	}

	.results {
		margin-top: 14px;
		display: grid;
		gap: 12px;
	}

	.empty {
		padding: 18px;
		display: grid;
		gap: 6px;
	}

	.empty-title {
		font-weight: 850;
	}

	.empty-sub {
		font-size: 13px;
	}

	:global(.search-results .post-card) {
		padding: 16px;
		display: grid;
		gap: 10px;
	}

	:global(.search-results .post-title) {
		display: inline-block;
		font-size: 18px;
		font-weight: 700;
		letter-spacing: 0.2px;
		text-decoration: none;
	}

	:global(.search-results .post-title:hover) {
		text-decoration: underline;
		text-decoration-color: color-mix(in oklab, var(--accent), transparent 55%);
	}

	:global(.search-results .post-sub) {
		display: inline-flex;
		align-items: center;
		gap: 8px;
		font-size: 13px;
	}

	:global(.search-results .dot) {
		opacity: 0.6;
	}

	:global(.search-results .cat) {
		color: inherit;
		text-decoration: none;
	}

	:global(.search-results .cat:hover) {
		text-decoration: underline;
	}

	:global(.search-results .desc) {
		margin: 0;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	:global(.search-results .tags) {
		display: flex;
		flex-wrap: wrap;
		gap: 8px;
	}

	@media (min-width: 980px) {
		.results {
			grid-template-columns: repeat(2, minmax(0, 1fr));
		}
		.empty {
			grid-column: 1 / -1;
		}
	}
</style>
